<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpO2 & Heartbeat Monitor with YOLOv8</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f9fafb; text-align: center; margin: 0; padding: 20px; }
        .container { width: 90%; max-width: 1000px; margin: auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .vital-display { font-size: 24px; font-weight: bold; margin: 10px 0; }
        .chart-container { position: relative; height: 300px; margin: 20px 0; }
        .stats-container { display: flex; justify-content: space-around; margin-bottom: 20px; }
        .stat-box { background-color: #f0f9ff; border-radius: 8px; padding: 15px; width: 45%; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .music-controls { margin-top: 20px; }
        .music-button, .pause-button { background-color: #4CAF50; color: white; border: none; padding: 10px 20px; font-size: 18px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .pause-button { background-color: #f39c12; display: none; }
        .progress-container { width: 80%; max-width: 600px; margin: auto; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-bar { height: 100%; width: 0%; background: #4CAF50; transition: width 0.5s linear; }
        .no-detection { font-size: 22px; font-weight: bold; color: #d9534f; text-align: center; margin-top: 15px; }
        .frame-container { display: flex; justify-content: center; margin-top: 20px; }
        .detection-heading { font-size: 28px; margin-top: 30px; color: #2c3e50; }
        .detection-item { font-size: 20px; padding: 8px; margin: 5px 0; background-color: #f8f9fa; border-radius: 6px; font-weight: 500; }
        .detection-container { margin-top: 20px; padding: 15px; border: 1px solid #e0e0e0; border-radius: 8px; background-color: #ffffff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>SpO2 & Heartbeat Monitor</h1>

        <div class="stats-container">
            <div class="stat-box">
                <div class="vital-display">SpO2: <span id="spo2-display">--</span>%</div>
            </div>
            <div class="stat-box">
                <div class="vital-display">Heart Rate: <span id="heart-rate-display">--</span> BPM</div>
            </div>
        </div>

        <div class="music-controls">
            <button class="music-button" onclick="toggleMusic()">Play</button>
            <button class="pause-button" onclick="pauseMusic()">Pause</button>
        </div>
        
        <div class="progress-container">
            <div class="progress-bar" id="music-progress"></div>
        </div>

        <div class="chart-container">
            <canvas id="vitals-chart"></canvas>
        </div>

        <h2>YOLOv8 Detection Results</h2>
        <div>
            <img id="yolo-frame" width="640" height="480">
        </div>
        <div id="detection-results"></div>
    </div>

    <script>
        var socket = io('http://' + document.domain + ':' + location.port);
        let isPlaying = false;
        let isPaused = false;
        let totalDuration = 120;  

        const ctx = document.getElementById('vitals-chart').getContext('2d');
        const vitalsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'SpO2 (%)', data: [], borderColor: 'blue', backgroundColor: 'rgba(54, 162, 235, 0.2)', borderWidth: 2, tension: 0.3 },
                    { label: 'Heart Rate (BPM)', data: [], borderColor: 'red', backgroundColor: 'rgba(255, 99, 132, 0.2)', borderWidth: 2, tension: 0.3 }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Time' } },
                    y: { title: { display: true, text: 'Vitals' }, min: 50, max: 150 }
                }
            }
        });

        function toggleMusic() {
            fetch('/toggle_music', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                let playButton = document.querySelector(".music-button");
                let pauseButton = document.querySelector(".pause-button");

                if (data.status === "playing") {
                    isPlaying = true;
                    isPaused = false;
                    playButton.textContent = "Stop";
                    pauseButton.style.display = "inline-block"; 
                    updateProgressBar();
                } else {
                    isPlaying = false;
                    isPaused = false;
                    playButton.textContent = "Play";
                    pauseButton.style.display = "none";
                    document.getElementById("music-progress").style.width = "0%";
                }
            })
            .catch(error => console.error("Error toggling music:", error));
        }

        function pauseMusic() {
            fetch('/pause_resume_music', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                let pauseButton = document.querySelector(".pause-button");

                if (data.status === "paused") {
                    isPaused = true;
                    pauseButton.textContent = "Resume";
                } else if (data.status === "resumed") {
                    isPaused = false;
                    pauseButton.textContent = "Pause";
                    updateProgressBar();
                }
            })
            .catch(error => console.error("Error pausing/resuming music:", error));
        }

        function updateProgressBar() {
            if (!isPlaying) return;

            fetch('/music_progress')
            .then(response => response.json())
            .then(data => {
                if (data.status === "playing") {
                    let progressPercent = (data.progress / totalDuration) * 100;
                    document.getElementById("music-progress").style.width = `${progressPercent}%`;
                }

                if (isPlaying && !isPaused) {
                    setTimeout(updateProgressBar, 1000);
                }
            })
            .catch(error => console.error("Error fetching music progress:", error));
        }

        socket.on('update_spo2', function(data) {
            document.getElementById('spo2-display').textContent = data.spo2;
            document.getElementById('heart-rate-display').textContent = data.heart_rate;

            vitalsChart.data.labels.push(new Date().toLocaleTimeString());
            vitalsChart.data.datasets[0].data.push(data.spo2);
            vitalsChart.data.datasets[1].data.push(data.heart_rate);
            if (vitalsChart.data.labels.length > 20) {
                vitalsChart.data.labels.shift();
                vitalsChart.data.datasets[0].data.shift();
                vitalsChart.data.datasets[1].data.shift();
            }
            vitalsChart.update();
        });

        socket.on('update_yolo', function(data) {
            document.getElementById('yolo-frame').src = "data:image/jpeg;base64," + data.frame;
    
            let detectionList = document.getElementById('detection-results');

            if (data.detections.length) {
                detectionList.innerHTML = `<h3>Detected Objects:</h3>` + 
                    data.detections.map(d => 
                        `<p class="detection-item">${d.class} - Confidence: ${(d.confidence * 100).toFixed(2)}%</p>`
                    ).join('');
            } else {
                detectionList.innerHTML = `<p class="no-detection">No objects detected</p>`;
            }
        });
    </script>
</body>
</html>